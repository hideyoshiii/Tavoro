<%#トップバー%>
<div class="bar_top">
  <div class="inline_block_middle" style="width:20%;">
    <div style="text-align:left;padding-left:20px;">
      <a href="javascript:void(0);" onclick="window.history.back();">
        <%= image_tag "left_FAFAFA.svg", :style =>'width:18px;height:18px;' %>
      </a>                    
    </div>
  </div>
  <div class="inline_block_middle" style="width:60%;">
    <div class="contain_title02" style="text-align:center;">
      <div style="font-size:14px;color:#FAFAFA;">
        アカウント編集
      </div>
    </div>
  </div>
  <div class="inline_block_middle" style="width:20%;">
    <div style="text-align:right;">
      <button id="btn_post" style="text-align:right;padding-right:15px;font-size:15px;color:#2FB4B4;">    
        変更
      </button> 
    </div>
  </div>
</div>
<div style="height:50px;"></div>

<%#エラーメッセージ%>
<%= devise_error_messages! %>

<%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
  <div style="height:20px;"></div>
  <%#アイコン画像%>
  <div class="form_user_edit_image" style="text-align:center;">
    <label for="image" id="preview">
      <% if current_user.image.present? %>
        <%= image_tag current_user.image(:large), :style => "width:110px;height:110px;border-radius:50%;object-fit:cover;", :id => "preview_image" %>
      <% else %>
        <%= image_tag "user.jpg", :style =>'width:110px;height:110px;border-radius:50%;object-fit:cover;', :id => "preview_image" %>
      <% end %>
      <span>
        <%= image_tag "camera_FAFAFA.svg", :style =>'width:20px;height:20px;opacity:0.5;' %>
      </span>
    </label>
    <%= f.file_field :image, id: "image" %>
  </div>
  <div style="height:20px;"></div>
  <%#名前%>
  <div style="padding:3px 15px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="inline_block_middle" style="width:90%;">
      <div style="font-size:12px;color:#FAFAFA;opacity:0.6;">
        name
      </div>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.text_field :name,placeholder: "名前", required: "", autofocus: true, :id => "name" %>
    </div>
  </div>
  <div style="height:30px;"></div> 
  <%#ユーザーid%>
  <div style="padding:5px 15px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="inline_block_middle" style="width:90%;">
      <div style="font-size:12px;color:#FAFAFA;opacity:0.6;">
        username
      </div>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.text_field :username,placeholder: "ユーザーid", required: "", autofocus: true, :id => "username" %>
    </div>
  </div>
  <div id='validate_username' style="padding:5px 15px;margin-left:10px;">
    <%= render partial: 'users/validate_username' %>
  </div>
  <div style="height:30px;"></div> 
  <%#自己紹介%>
  <div style="padding:5px 15px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="inline_block_middle" style="width:90%;">
      <div style="font-size:12px;color:#FAFAFA;opacity:0.6;">
        description
      </div>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_description">
      <%= f.text_area :description, placeholder: "自己紹介を書く", autofocus: true, id: "textarea" %>
    </div>
  </div>
  <div style="height:30px;"></div>
  <%#email%>
  <div style="padding:5px 15px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="inline_block_middle" style="width:90%;">
      <div style="font-size:12px;color:#FAFAFA;opacity:0.6;">
        e-mail
      </div>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.email_field :email,placeholder: "メールアドレス", required: "", autofocus: true, :id => "email" %>
    </div>
  </div>
  <div style="height:30px;"></div>
  <%#password%>
  <div style="padding:5px 15px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="inline_block_middle" style="width:90%;">
      <div style="font-size:12px;color:#FAFAFA;opacity:0.6;">
        password(変更時のみ)
      </div>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.password_field :current_password, placeholder: "現在のパスワード" , :id => "current_password"%>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.password_field :password,placeholder: "パスワード", :id => "password" %>
    </div>
  </div>
  <div style="padding:5px 15px;margin-left:10px;border-bottom:solid 0.5px rgba(150, 150, 150, 0.2);">
    <div class="form_user_edit_name">
      <%= f.password_field :password_confirmation,:placeholder => 'パスワード(確認用)', :id => "password_confirmation" %>
    </div>
  </div>
  <div style="height:30px;"></div>
<% end %>


<%#投稿ボタンボタン%>
<script defer>
  $(function(){
    //フォームにname属性を追加
    var name = $('#edit_user').attr('name', 'myform');
    $('#btn_post').click(function() {
      document.myform.submit();
    });
  });
</script>
<%#テキストエリアの自動改行%>
<script defer>
  $(function() {
    var $textarea = $('#textarea');
    var lineHeight = parseInt($textarea.css('lineHeight'));
    $(function() {
        var lines = ($textarea.val() + '\n').match(/\n/g).length;
        $textarea.height(lineHeight * lines);
      });
    $textarea.on('input', function(e) {
      var lines = ($(this).val() + '\n').match(/\n/g).length;
      $(this).height(lineHeight * lines);
    });
  });
</script>
<%#キーボードを閉じる%>
<script defer>
  $(function(){
    $('#name').keypress(function(e) {
      if ( e.which == 13 ) {
        $("#name").blur();
        return false;
      }
    });
    $('#email').keypress(function(e) {
      if ( e.which == 13 ) {
        $("#email").blur();
        return false;
      }
    });
    $('#current_password').keypress(function(e) {
      if ( e.which == 13 ) {
        $("#current_password").blur();
        return false;
      }
    });
    $('#password').keypress(function(e) {
      if ( e.which == 13 ) {
        $("#password").blur();
        return false;
      }
    });
    $('#password_confirmation').keypress(function(e) {
      if ( e.which == 13 ) {
        $("#password_confirmation").blur();
        return false;
      }
    });
  });
</script>
<%#idのvalidation%>
<script defer>
  $(function(){
    var
    preFunc = null,
    preInput = '',
    input = '',
    ajaxPost = function(input)
    {
      $.ajax({
        url: "/users/ajax_validate_username",
          type: "GET",
          data: ("q=" + input)
      });
    };
    //初期値の判定
    input = $('#username').val();
    ajaxPost(input);
    $('#username').keyup(function() {
      input = $(this).val(); //前後の不要な空白を削除
      if(preInput !== input){
        clearTimeout(preFunc);
        preFunc = setTimeout(ajaxPost(input), 0);
      }
      preInput = input;
    });
    $('#username').keypress(function(e) {
      if ( e.which == 13 ) {
        clearTimeout(preFunc);
        preFunc = setTimeout(ajaxPost(input), 0);
        // スマホのキーボードを閉じる
        $("#username").blur();
        return false;
      }
    })
  });
</script>
<%#画像プレビュー%>
<script defer>
  $(function(){
    $('#image').on('change', function (e) {
      var reader = new FileReader();
      reader.onload = function (e) {
          $("#preview_image").attr('src', e.target.result);
      }
      reader.readAsDataURL(e.target.files[0]);
    });
  });
</script>
<%#ブラウザバック変更%>
<% if request.referer&.include?(request.host_with_port) %>
  <% if request.referer&.include?("edit") %>
    <script defer>
      $(function() {
          // 戻るボタンを押された時に何も処理を行わない
        history.pushState(null, null, null);
        // 戻るボタンを押した時の処理を追加
        window.addEventListener("popstate", function() {
          location.replace("<%= root_url(only_path: false) %><%= current_user.username %>");
        })
      });
    </script>
  <% end %>
<% end %>